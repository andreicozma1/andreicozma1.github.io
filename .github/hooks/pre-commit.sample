#!/bin/bash
#
# OPTIONAL Pre-commit hook to validate GitHub Actions workflow files locally
#
# NOTE: This is OPTIONAL for faster local feedback.
#       Validation is MANDATORY via CI - no local setup required.
#
# To enable this hook (one-time per developer):
#   git config core.hooksPath .github/hooks
#   chmod +x .github/hooks/pre-commit.sample
#   mv .github/hooks/pre-commit.sample .github/hooks/pre-commit

set -e

# Get list of staged workflow files
STAGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^.github/workflows/.*\.ya?ml$' || true)

if [ -z "$STAGED_WORKFLOWS" ]; then
  # No workflow files staged, skip validation
  exit 0
fi

echo "üîç Validating workflow files..."
echo ""

# Check if actionlint is available, install if not
if ! command -v actionlint &> /dev/null; then
  echo "üì• Installing actionlint..."
  if bash <(curl -fsSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash); then
    sudo mv actionlint /usr/local/bin/ 2>/dev/null || {
      echo "‚ö†Ô∏è  Could not install to /usr/local/bin (needs sudo)"
      echo "Installing to current directory..."
      # actionlint is already in current dir from download script
    }
  else
    echo "‚ùå Failed to download actionlint"
    echo "Skipping validation (will be checked by CI)"
    exit 0
  fi
fi

# Determine actionlint path
if command -v actionlint &> /dev/null; then
  ACTIONLINT="actionlint"
elif [ -f "./actionlint" ]; then
  ACTIONLINT="./actionlint"
else
  echo "‚ö†Ô∏è  actionlint not available, skipping local validation"
  echo "CI will validate workflows on push"
  exit 0
fi

# Validate each staged workflow file
VALIDATION_FAILED=0
for file in $STAGED_WORKFLOWS; do
  echo "Validating: $file"
  if ! $ACTIONLINT "$file"; then
    VALIDATION_FAILED=1
  fi
done

if [ $VALIDATION_FAILED -eq 1 ]; then
  echo ""
  echo "‚ùå Workflow validation failed!"
  echo "Please fix the errors above before committing."
  echo ""
  echo "To skip this check (not recommended):"
  echo "  git commit --no-verify"
  exit 1
fi

echo ""
echo "‚úÖ All workflow files are valid"
exit 0
