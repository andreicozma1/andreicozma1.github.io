name: Deploy to GitHub Pages

on:
  push:
    branches: ["source"]

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup environment
        run: |
          echo "$SFC" | base64 -d > ./.env
        env:
          SFC: ${{ secrets.SECRETS_FILE_CONTENTS }}

      - name: Restore Gatsby cache
        uses: actions/cache@v4
        with:
          path: |
            public
            .cache
          key: gatsby-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            gatsby-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            gatsby-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build
        env:
          CI: true

      - name: Generate build stats for comparison
        run: |
          mkdir -p .build-stats
          echo "{
            \"total_bytes\": $(du -sb public | cut -f1),
            \"js_bytes\": $(find public -name '*.js' -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo 0),
            \"css_bytes\": $(find public -name '*.css' -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo 0),
            \"html_count\": $(find public -name '*.html' | wc -l),
            \"img_count\": $(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) 2>/dev/null | wc -l),
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"commit\": \"${{ github.sha }}\"
          }" > .build-stats/base-stats.json
          cat .build-stats/base-stats.json

      - name: Cache build stats for PR comparison
        uses: actions/cache/save@v4
        with:
          path: .build-stats
          key: build-stats-${{ github.ref_name }}-${{ github.sha }}

      - name: Update latest build stats cache
        uses: actions/cache/save@v4
        with:
          path: .build-stats
          key: build-stats-${{ github.ref_name }}-latest

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: main
          publish_dir: ./public
