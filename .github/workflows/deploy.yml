name: Deploy to GitHub Pages

on:
  push:
    branches: ["source"]

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup environment
        run: |
          echo "$SFC" | base64 -d > ./.env
        env:
          SFC: ${{ secrets.SECRETS_FILE_CONTENTS }}

      - name: Restore Gatsby cache
        uses: actions/cache@v4
        with:
          path: |
            public
            .cache
          key: gatsby-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            gatsby-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            gatsby-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build
        env:
          CI: true

      - name: Generate build stats for comparison
        run: |
          set -euo pipefail
          mkdir -p .build-stats

          # Collect stats with explicit error checking
          if [ ! -d "public" ]; then
            echo "Error: public directory does not exist"
            exit 1
          fi

          # Calculate sizes - du returns bytes, we capture just the number
          total_bytes=$(du -sb public | cut -f1)

          # Count files - handle case where no files match
          js_files=$(find public -name '*.js' -type f 2>/dev/null)
          if [ -n "$js_files" ]; then
            js_bytes=$(echo "$js_files" | xargs du -cb | tail -1 | cut -f1)
          else
            js_bytes=0
          fi

          css_files=$(find public -name '*.css' -type f 2>/dev/null)
          if [ -n "$css_files" ]; then
            css_bytes=$(echo "$css_files" | xargs du -cb | tail -1 | cut -f1)
          else
            css_bytes=0
          fi

          html_count=$(find public -name '*.html' -type f 2>/dev/null | wc -l | tr -d ' ')
          img_count=$(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) -type f 2>/dev/null | wc -l | tr -d ' ')

          # Generate JSON using jq for proper escaping and formatting
          jq -n \
            --argjson total_bytes "$total_bytes" \
            --argjson js_bytes "$js_bytes" \
            --argjson css_bytes "$css_bytes" \
            --argjson html_count "$html_count" \
            --argjson img_count "$img_count" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg commit "${{ github.sha }}" \
            '{
              total_bytes: $total_bytes,
              js_bytes: $js_bytes,
              css_bytes: $css_bytes,
              html_count: $html_count,
              img_count: $img_count,
              timestamp: $timestamp,
              commit: $commit
            }' > .build-stats/base-stats.json

          # Validate the generated JSON
          if ! jq empty .build-stats/base-stats.json 2>/dev/null; then
            echo "Error: Generated invalid JSON"
            exit 1
          fi

          echo "Build stats generated:"
          jq . .build-stats/base-stats.json

      - name: Cache build stats for PR comparison
        uses: actions/cache/save@v4
        with:
          path: .build-stats
          key: build-stats-${{ github.ref_name }}-${{ github.sha }}

      - name: Update latest build stats cache
        uses: actions/cache/save@v4
        with:
          path: .build-stats
          key: build-stats-${{ github.ref_name }}-latest

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: main
          publish_dir: ./public
