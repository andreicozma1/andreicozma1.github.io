name: "PR: Cleanup Preview"

on:
  pull_request:
    types: [closed]
    branches: ["main"]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Teardown Surge preview
        id: teardown
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          set -uo pipefail

          PREVIEW_URL="pr-${{ github.event.pull_request.number }}-andreicozma1.surge.sh"
          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT

          if [ -z "${SURGE_TOKEN:-}" ]; then
            echo "::warning::SURGE_TOKEN not set, skipping teardown"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Attempt teardown and capture output
          set +e  # Don't exit on error
          TEARDOWN_OUTPUT=$(npx surge teardown "${PREVIEW_URL}" --token "$SURGE_TOKEN" 2>&1)
          TEARDOWN_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          echo "$TEARDOWN_OUTPUT"

          if [ $TEARDOWN_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            # Teardown failed - Surge doesn't differentiate between error types in exit codes
            # All failures return exit code 1 with message: "Aborted - unable to remove <domain>"
            # This could mean: domain doesn't exist, auth failure, network error, etc.
            #
            # Unfortunately, Surge CLI provides no way to distinguish these cases:
            # - No JSON output flag
            # - No verbose mode
            # - No specific exit codes
            # - Generic error message for all failures
            #
            # Since we cannot reliably detect "domain doesn't exist" vs real errors,
            # we must treat all teardown failures as actual errors to avoid hiding
            # real problems (auth failures, network issues, etc.)

            echo "::error::Surge teardown failed"
            echo "::error::Exit code: $TEARDOWN_EXIT_CODE"
            echo "::error::Output: $TEARDOWN_OUTPUT"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify teardown
        if: steps.teardown.outputs.status == 'success'
        run: |
          PREVIEW_URL="${{ steps.teardown.outputs.preview_url }}"

          # Wait briefly for teardown to propagate
          sleep 5

          # Verify site is no longer accessible (expect 4xx or connection failure)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${PREVIEW_URL}" --max-time 10 || echo "000")

          if [ "$HTTP_STATUS" = "000" ] || [ "$HTTP_STATUS" -ge 400 ]; then
            echo "âœ… Verified: Preview site is no longer accessible (HTTP $HTTP_STATUS)"
            echo "verified=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Preview site may still be accessible (HTTP $HTTP_STATUS)"
            echo "verified=false" >> $GITHUB_OUTPUT
          fi

      - name: Job summary
        if: always()
        run: |
          STATUS="${{ steps.teardown.outputs.status }}"
          PREVIEW_URL="${{ steps.teardown.outputs.preview_url }}"

          echo "## ðŸ§¹ Preview Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$STATUS" in
            success)
              echo "âœ… **Teardown successful**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- URL: \`${PREVIEW_URL}\`" >> $GITHUB_STEP_SUMMARY
              echo "- PR: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
              ;;
            skipped)
              echo "â­ï¸ **Teardown skipped** (SURGE_TOKEN not configured)" >> $GITHUB_STEP_SUMMARY
              ;;
            failed)
              echo "âŒ **Teardown failed**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- URL: \`${PREVIEW_URL}\`" >> $GITHUB_STEP_SUMMARY
              echo "- Check logs for details" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "âš ï¸ **Unknown status**: ${STATUS:-none}" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
