name: CI

on:
  pull_request:
    branches: ["source"]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for base branch comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup environment
        run: |
          echo "$SFC" | base64 -d > ./.env
        env:
          SFC: ${{ secrets.SECRETS_FILE_CONTENTS }}

      - name: Build base branch for comparison
        id: base-build
        run: |
          set -uo pipefail  # Note: no -e, we handle errors manually

          echo "Building base branch (${{ github.base_ref }}) for comparison..."

          # Save current HEAD
          PR_HEAD=$(git rev-parse HEAD)

          # Checkout base branch
          git checkout origin/${{ github.base_ref }}

          # Clean any previous build artifacts and install base branch dependencies
          rm -rf public .cache node_modules
          npm ci

          # Try to build base branch and capture output
          build_output=$(npm run build 2>&1) && build_success=true || build_success=false

          if [ "$build_success" = "true" ]; then
            echo "base_build_success=true" >> $GITHUB_OUTPUT

            # Collect base stats
            if [ -d "public" ]; then
              base_total=$(du -sb public | cut -f1)

              js_files=$(find public -name '*.js' -type f 2>/dev/null)
              if [ -n "$js_files" ]; then
                base_js=$(echo "$js_files" | xargs du -cb | tail -1 | cut -f1)
              else
                base_js=0
              fi

              css_files=$(find public -name '*.css' -type f 2>/dev/null)
              if [ -n "$css_files" ]; then
                base_css=$(echo "$css_files" | xargs du -cb | tail -1 | cut -f1)
              else
                base_css=0
              fi

              base_html=$(find public -name '*.html' -type f 2>/dev/null | wc -l | tr -d ' ')
              base_img=$(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) -type f 2>/dev/null | wc -l | tr -d ' ')

              echo "base_total=${base_total}" >> $GITHUB_OUTPUT
              echo "base_js=${base_js}" >> $GITHUB_OUTPUT
              echo "base_css=${base_css}" >> $GITHUB_OUTPUT
              echo "base_html=${base_html}" >> $GITHUB_OUTPUT
              echo "base_img=${base_img}" >> $GITHUB_OUTPUT

              echo "Base build stats: total=${base_total}, js=${base_js}, css=${base_css}, html=${base_html}, img=${base_img}"
            fi
          else
            echo "::warning::Base branch build failed - comparison will be skipped."
            echo "base_build_success=false" >> $GITHUB_OUTPUT

            # Extract key error info (last 5 lines of error, truncated)
            error_summary=$(echo "$build_output" | grep -i "error" | tail -3 | head -c 200)
            if [ -n "$error_summary" ]; then
              # Escape for GitHub Output (replace newlines, special chars)
              error_escaped=$(echo "$error_summary" | tr '\n' ' ' | sed 's/"/\\"/g')
              echo "base_build_error=${error_escaped}" >> $GITHUB_OUTPUT
            fi
          fi

          # Clean up and return to PR
          rm -rf public .cache node_modules
          git checkout $PR_HEAD

          echo "Returned to PR branch"
        env:
          CI: true

      - name: Install dependencies
        run: npm ci

      - name: Type check
        id: typecheck
        run: |
          # Enable TypeScript problem matcher for inline annotations
          echo "::add-matcher::.github/matchers/typescript.json"

          echo "## TypeScript Check" >> $GITHUB_STEP_SUMMARY
          if npm run typecheck 2>&1 | tee typecheck-output.txt; then
            echo "‚úÖ No type errors found" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Type errors detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat typecheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
            # Output errors again for the matcher to pick up
            cat typecheck-output.txt
            exit 1
          fi

          echo "::remove-matcher owner=tsc::"

      - name: Build PR branch
        id: build
        run: |
          echo "## Build" >> $GITHUB_STEP_SUMMARY
          BUILD_START=$(date +%s)
          npm run build
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "‚úÖ Build completed in ${BUILD_TIME}s" >> $GITHUB_STEP_SUMMARY
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Generate build stats and compare
        id: stats
        run: |
          set -euo pipefail

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify public directory exists
          if [ ! -d "public" ]; then
            echo "Error: public directory does not exist after build"
            exit 1
          fi

          # Calculate PR build sizes
          total_bytes=$(du -sb public | cut -f1)
          total_size=$(du -sh public | cut -f1)

          js_files=$(find public -name '*.js' -type f 2>/dev/null)
          if [ -n "$js_files" ]; then
            js_bytes=$(echo "$js_files" | xargs du -cb | tail -1 | cut -f1)
            js_size=$(echo "$js_files" | xargs du -ch | tail -1 | cut -f1)
          else
            js_bytes=0
            js_size="0"
          fi

          css_files=$(find public -name '*.css' -type f 2>/dev/null)
          if [ -n "$css_files" ]; then
            css_bytes=$(echo "$css_files" | xargs du -cb | tail -1 | cut -f1)
            css_size=$(echo "$css_files" | xargs du -ch | tail -1 | cut -f1)
          else
            css_bytes=0
            css_size="0"
          fi

          html_count=$(find public -name '*.html' -type f 2>/dev/null | wc -l | tr -d ' ')
          img_count=$(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) -type f 2>/dev/null | wc -l | tr -d ' ')

          # Get top 5 largest JS files
          TOP_JS=$(find public -name "*.js" -type f -exec du -h {} \; 2>/dev/null | sort -rh | head -5)

          # Store outputs for PR comment
          echo "total_size=${total_size}" >> $GITHUB_OUTPUT
          echo "total_bytes=${total_bytes}" >> $GITHUB_OUTPUT
          echo "html_count=${html_count}" >> $GITHUB_OUTPUT
          echo "js_size=${js_size}" >> $GITHUB_OUTPUT
          echo "js_bytes=${js_bytes}" >> $GITHUB_OUTPUT
          echo "css_size=${css_size}" >> $GITHUB_OUTPUT
          echo "css_bytes=${css_bytes}" >> $GITHUB_OUTPUT
          echo "img_count=${img_count}" >> $GITHUB_OUTPUT

          # Check if base build succeeded for comparison
          if [ "${{ steps.base-build.outputs.base_build_success }}" = "true" ]; then
            base_total=${{ steps.base-build.outputs.base_total }}
            base_js=${{ steps.base-build.outputs.base_js }}
            base_css=${{ steps.base-build.outputs.base_css }}
            base_html=${{ steps.base-build.outputs.base_html }}
            base_img=${{ steps.base-build.outputs.base_img }}

            delta_total=$((total_bytes - base_total))
            delta_js=$((js_bytes - base_js))
            delta_css=$((css_bytes - base_css))
            delta_html=$((html_count - base_html))
            delta_img=$((img_count - base_img))

            echo "has_comparison=true" >> $GITHUB_OUTPUT
            echo "delta_total=${delta_total}" >> $GITHUB_OUTPUT
            echo "delta_js=${delta_js}" >> $GITHUB_OUTPUT
            echo "delta_css=${delta_css}" >> $GITHUB_OUTPUT
            echo "delta_html=${delta_html}" >> $GITHUB_OUTPUT
            echo "delta_img=${delta_img}" >> $GITHUB_OUTPUT

            # Write to step summary with comparison
            echo "| Metric | Value | Œî vs base |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------:|----------:|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Size | ${total_size} | ${delta_total} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| HTML Pages | ${html_count} | ${delta_html} |" >> $GITHUB_STEP_SUMMARY
            echo "| JavaScript | ${js_size} | ${delta_js} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS | ${css_size} | ${delta_css} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| Images | ${img_count} | ${delta_img} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_comparison=false" >> $GITHUB_OUTPUT

            # Write to step summary without comparison
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------:|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Size | ${total_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| HTML Pages | ${html_count} |" >> $GITHUB_STEP_SUMMARY
            echo "| JavaScript | ${js_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS | ${css_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| Images | ${img_count} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ‚ö†Ô∏è _Base branch (\`${{ github.base_ref }}\`) build failed - comparison not available._" >> $GITHUB_STEP_SUMMARY

            # Show error if captured
            base_error="${{ steps.base-build.outputs.base_build_error }}"
            if [ -n "$base_error" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>Build error</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$base_error" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Save top JS files using heredoc
          {
            echo "top_js<<TOPJS_EOF"
            echo "$TOP_JS"
            echo "TOPJS_EOF"
          } >> $GITHUB_OUTPUT

      - name: Check for large bundles
        id: bundles
        run: |
          set -euo pipefail

          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find JS files larger than 200KB
          large_files=$(find public -name "*.js" -type f -size +200k 2>/dev/null || true)

          if [ -n "$large_files" ]; then
            large_count=$(echo "$large_files" | wc -l | tr -d ' ')
            echo "large_count=${large_count}" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è **Large JavaScript files (>200KB): ${large_count}**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$large_files" | xargs du -h | sort -rh >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "has_large=true" >> $GITHUB_OUTPUT
          else
            echo "large_count=0" >> $GITHUB_OUTPUT
            echo "‚úÖ No JavaScript files exceed 200KB" >> $GITHUB_STEP_SUMMARY
            echo "has_large=false" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment with build stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Helper to format bytes
            const formatBytes = (bytes) => {
              const abs = Math.abs(bytes);
              if (abs >= 1048576) return (bytes / 1048576).toFixed(2) + 'M';
              if (abs >= 1024) return (bytes / 1024).toFixed(1) + 'K';
              return bytes + 'B';
            };

            // Helper to format delta with icon
            const formatDelta = (delta) => {
              if (delta === 0) return '-';
              const sign = delta > 0 ? '+' : '';
              const icon = delta > 0 ? 'üìà' : 'üìâ';
              return `${sign}${formatBytes(delta)} ${icon}`;
            };

            // Get build stats
            const totalSize = '${{ steps.stats.outputs.total_size }}';
            const totalBytes = parseInt('${{ steps.stats.outputs.total_bytes }}') || 0;
            const htmlCount = parseInt('${{ steps.stats.outputs.html_count }}') || 0;
            const jsSize = '${{ steps.stats.outputs.js_size }}';
            const jsBytes = parseInt('${{ steps.stats.outputs.js_bytes }}') || 0;
            const cssSize = '${{ steps.stats.outputs.css_size }}';
            const cssBytes = parseInt('${{ steps.stats.outputs.css_bytes }}') || 0;
            const imgCount = parseInt('${{ steps.stats.outputs.img_count }}') || 0;
            const buildTime = '${{ steps.build.outputs.build_time }}';
            const hasLargeBundles = '${{ steps.bundles.outputs.has_large }}' === 'true';
            const largeCount = '${{ steps.bundles.outputs.large_count }}';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Check if comparison is available
            const hasComparison = '${{ steps.stats.outputs.has_comparison }}' === 'true';

            // Get deltas (only if comparison available)
            let deltaTotal = 0, deltaJs = 0, deltaCss = 0, deltaHtml = 0, deltaImg = 0;
            if (hasComparison) {
              deltaTotal = parseInt('${{ steps.stats.outputs.delta_total }}') || 0;
              deltaJs = parseInt('${{ steps.stats.outputs.delta_js }}') || 0;
              deltaCss = parseInt('${{ steps.stats.outputs.delta_css }}') || 0;
              deltaHtml = parseInt('${{ steps.stats.outputs.delta_html }}') || 0;
              deltaImg = parseInt('${{ steps.stats.outputs.delta_img }}') || 0;
            }

            // Build status indicator
            const bundleStatus = hasLargeBundles
              ? `‚ö†Ô∏è ${largeCount} large bundle(s) detected (>200KB)`
              : '‚úÖ No large bundles';

            // Format top JS files
            const topJs = `${{ steps.stats.outputs.top_js }}`.trim();
            const topJsFormatted = topJs ? topJs.split('\n').map(line => {
              const parts = line.trim().split(/\s+/);
              if (parts.length >= 2) {
                const size = parts[0];
                const file = parts[1].replace('public/', '');
                return `| \`${file}\` | ${size} |`;
              }
              return '';
            }).filter(Boolean).join('\n') : '| _No JS files found_ | - |';

            // Build the stats table (with or without comparison)
            let statsTable;
            if (hasComparison) {
              statsTable = `| Metric | Value | Œî vs base |
            |:-------|------:|----------:|
            | ‚è±Ô∏è Build Time | **${buildTime}s** | - |
            | üì¶ Total Size | **${totalSize}** | ${formatDelta(deltaTotal)} |
            | üìÑ HTML Pages | ${htmlCount} | ${deltaHtml !== 0 ? (deltaHtml > 0 ? '+' : '') + deltaHtml : '-'} |
            | üìú JavaScript | ${jsSize} | ${formatDelta(deltaJs)} |
            | üé® CSS | ${cssSize} | ${formatDelta(deltaCss)} |
            | üñºÔ∏è Images | ${imgCount} | ${deltaImg !== 0 ? (deltaImg > 0 ? '+' : '') + deltaImg : '-'} |`;
            } else {
              const baseError = `${{ steps.base-build.outputs.base_build_error }}`.trim();
              const errorNote = baseError
                ? `\n\n<details>\n<summary>Build error</summary>\n\n\`\`\`\n${baseError}\n\`\`\`\n</details>`
                : '';

              statsTable = `| Metric | Value |
            |:-------|------:|
            | ‚è±Ô∏è Build Time | **${buildTime}s** |
            | üì¶ Total Size | **${totalSize}** |
            | üìÑ HTML Pages | ${htmlCount} |
            | üìú JavaScript | ${jsSize} |
            | üé® CSS | ${cssSize} |
            | üñºÔ∏è Images | ${imgCount} |

            > ‚ö†Ô∏è _Base branch (\`${{ github.base_ref }}\`) build failed - comparison not available._${errorNote}`;
            }

            const body = `## üìä Build Report

            ${statsTable}

            ### Bundle Status
            ${bundleStatus}

            <details>
            <summary>üìÅ Top 5 Largest JS Files</summary>

            | File | Size |
            |:-----|-----:|
            ${topJsFormatted}

            </details>

            ---
            ‚úÖ All checks passed! [View full details](${runUrl})

            <sub>Updated: ${new Date().toISOString()}</sub>`;

            // Find existing comment and post/update
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('üìä Build Report')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (error) {
              console.error('Failed to post PR comment:', error);
              // Don't fail the workflow if comment posting fails
            }

      - name: Deploy preview to Surge
        id: surge
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          if [ -z "${SURGE_TOKEN:-}" ]; then
            echo "SURGE_TOKEN not configured - skipping preview deployment"
            echo "deployed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREVIEW_URL="pr-${{ github.event.pull_request.number }}-andreicozma1.surge.sh"

          if npx surge ./public "${PREVIEW_URL}" --token "$SURGE_TOKEN"; then
            echo "url=https://${PREVIEW_URL}" >> $GITHUB_OUTPUT
            echo "deployed=true" >> $GITHUB_OUTPUT
            echo "üöÄ Preview deployed to https://${PREVIEW_URL}"
          else
            echo "Surge deployment failed"
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PR comment with preview URL
        if: github.event_name == 'pull_request' && steps.surge.outputs.deployed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.surge.outputs.url }}';

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('üìä Build Report')
              );

              if (botComment && !botComment.body.includes('üöÄ Preview')) {
                const updatedBody = botComment.body.replace(
                  /---\s*\n\s*‚úÖ All checks passed!/,
                  `### üöÄ Preview
            [View Preview](${previewUrl})

            ---
            ‚úÖ All checks passed!`
                );

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: updatedBody
                });
              }
            } catch (error) {
              console.error('Failed to update PR comment with preview URL:', error);
            }
