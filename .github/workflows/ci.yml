name: "PR: Validate & Preview"

on:
  pull_request:
    branches: ["source"]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for base branch comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Post initial PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const commitSha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const body = `<!-- build-report -->
## CI Report<!-- preview-marker -->

‚è≥ Types ¬∑ ‚è≥ Build ¬∑ ‚è≥ Stats

_Running..._

\`${commitSha}\` ¬∑ ${runUrl} ¬∑ _${timestamp}_`;

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- build-report -->')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (error) {
              console.error('Failed to post initial PR comment:', error);
            }

      - name: Setup environment
        run: |
          if [ -z "${SFC:-}" ]; then
            echo "::warning::SECRETS_FILE_CONTENTS not configured - .env will be empty"
            touch ./.env
          else
            echo "$SFC" | base64 -d > ./.env
            echo "Environment configured ($(wc -l < ./.env) lines)"
          fi
        env:
          SFC: ${{ secrets.SECRETS_FILE_CONTENTS }}

      - name: Get base branch commit SHA
        id: base-sha
        run: |
          BASE_SHA=$(git rev-parse origin/${{ github.base_ref }})
          echo "sha=${BASE_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${BASE_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "Base branch ${{ github.base_ref }} is at ${BASE_SHA:0:7}"

      - name: Check base stats cache
        id: base-cache
        uses: actions/cache@v4
        with:
          path: .base-stats.json
          key: base-stats-${{ github.base_ref }}-${{ steps.base-sha.outputs.sha }}

      - name: Load cached base stats
        id: cached-stats
        if: steps.base-cache.outputs.cache-hit == 'true'
        run: |
          echo "Using cached base stats for ${{ steps.base-sha.outputs.short_sha }}"

          # Read stats from cached JSON
          cat .base-stats.json

          # Export to outputs
          echo "base_build_success=true" >> $GITHUB_OUTPUT
          echo "base_total=$(jq -r '.base_total' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_js=$(jq -r '.base_js' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_css=$(jq -r '.base_css' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_html=$(jq -r '.base_html' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_img=$(jq -r '.base_img' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_total_size=$(jq -r '.base_total_size' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_js_size=$(jq -r '.base_js_size' .base-stats.json)" >> $GITHUB_OUTPUT
          echo "base_css_size=$(jq -r '.base_css_size' .base-stats.json)" >> $GITHUB_OUTPUT

      - name: Build base branch for comparison
        id: base-build
        if: steps.base-cache.outputs.cache-hit != 'true'
        run: |
          set -uo pipefail  # Note: no -e, we handle errors manually

          echo "Building base branch (${{ github.base_ref }} @ ${{ steps.base-sha.outputs.short_sha }})..."

          # Save current HEAD
          PR_HEAD=$(git rev-parse HEAD)

          # Checkout base branch
          git checkout origin/${{ github.base_ref }}

          # Clean any previous build artifacts and install base branch dependencies
          rm -rf public .cache node_modules
          npm ci

          # Try to build base branch and capture output
          build_output=$(npm run build 2>&1) && build_success=true || build_success=false

          if [ "$build_success" = "true" ]; then
            echo "base_build_success=true" >> $GITHUB_OUTPUT

            # Collect base stats
            if [ -d "public" ]; then
              base_total=$(du -sb public | cut -f1)

              js_files=$(find public -name '*.js' -type f 2>/dev/null)
              if [ -n "$js_files" ]; then
                base_js=$(echo "$js_files" | xargs du -cb | tail -1 | cut -f1)
              else
                base_js=0
              fi

              css_files=$(find public -name '*.css' -type f 2>/dev/null)
              if [ -n "$css_files" ]; then
                base_css=$(echo "$css_files" | xargs du -cb | tail -1 | cut -f1)
              else
                base_css=0
              fi

              base_html=$(find public -name '*.html' -type f 2>/dev/null | wc -l | tr -d ' ')
              base_img=$(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) -type f 2>/dev/null | wc -l | tr -d ' ')

              # Output human-readable sizes for display
              base_total_size=$(du -sh public | cut -f1)
              if [ -n "$js_files" ]; then
                base_js_size=$(echo "$js_files" | xargs du -ch | tail -1 | cut -f1)
              else
                base_js_size="0"
              fi
              if [ -n "$css_files" ]; then
                base_css_size=$(echo "$css_files" | xargs du -ch | tail -1 | cut -f1)
              else
                base_css_size="0"
              fi

              # Output to GITHUB_OUTPUT
              echo "base_total=${base_total}" >> $GITHUB_OUTPUT
              echo "base_js=${base_js}" >> $GITHUB_OUTPUT
              echo "base_css=${base_css}" >> $GITHUB_OUTPUT
              echo "base_html=${base_html}" >> $GITHUB_OUTPUT
              echo "base_img=${base_img}" >> $GITHUB_OUTPUT
              echo "base_total_size=${base_total_size}" >> $GITHUB_OUTPUT
              echo "base_js_size=${base_js_size}" >> $GITHUB_OUTPUT
              echo "base_css_size=${base_css_size}" >> $GITHUB_OUTPUT

              # Save to JSON for caching (will be saved by cache action post-job)
              jq -n \
                --arg base_total "$base_total" \
                --arg base_js "$base_js" \
                --arg base_css "$base_css" \
                --arg base_html "$base_html" \
                --arg base_img "$base_img" \
                --arg base_total_size "$base_total_size" \
                --arg base_js_size "$base_js_size" \
                --arg base_css_size "$base_css_size" \
                '{base_total: $base_total, base_js: $base_js, base_css: $base_css, base_html: $base_html, base_img: $base_img, base_total_size: $base_total_size, base_js_size: $base_js_size, base_css_size: $base_css_size}' \
                > .base-stats.json

              echo "Base build stats: total=${base_total_size}, js=${base_js_size}, css=${base_css_size}, html=${base_html}, img=${base_img}"
            fi
          else
            echo "::warning::Base branch build failed - comparison will be skipped."
            echo "base_build_success=false" >> $GITHUB_OUTPUT

            # Extract last few lines of build output (more reliable than grep)
            error_summary=$(echo "$build_output" | tail -10)
            if [ -n "$error_summary" ]; then
              # Use heredoc for multiline GitHub output (proper escaping)
              {
                echo "base_build_error<<ERROR_EOF"
                echo "$error_summary"
                echo "ERROR_EOF"
              } >> $GITHUB_OUTPUT
            fi
          fi

          # Clean up and return to PR
          rm -rf public .cache node_modules
          git checkout $PR_HEAD

          echo "Returned to PR branch"
        env:
          CI: true

      # Consolidate base stats from cache or build into single source
      - name: Consolidate base stats
        id: base-stats
        run: |
          # Use cached stats if available, otherwise use build stats
          if [ "${{ steps.base-cache.outputs.cache-hit }}" = "true" ]; then
            echo "Using cached base stats"
            echo "from_cache=true" >> $GITHUB_OUTPUT
            echo "base_build_success=${{ steps.cached-stats.outputs.base_build_success }}" >> $GITHUB_OUTPUT
            echo "base_total=${{ steps.cached-stats.outputs.base_total }}" >> $GITHUB_OUTPUT
            echo "base_js=${{ steps.cached-stats.outputs.base_js }}" >> $GITHUB_OUTPUT
            echo "base_css=${{ steps.cached-stats.outputs.base_css }}" >> $GITHUB_OUTPUT
            echo "base_html=${{ steps.cached-stats.outputs.base_html }}" >> $GITHUB_OUTPUT
            echo "base_img=${{ steps.cached-stats.outputs.base_img }}" >> $GITHUB_OUTPUT
            echo "base_total_size=${{ steps.cached-stats.outputs.base_total_size }}" >> $GITHUB_OUTPUT
            echo "base_js_size=${{ steps.cached-stats.outputs.base_js_size }}" >> $GITHUB_OUTPUT
            echo "base_css_size=${{ steps.cached-stats.outputs.base_css_size }}" >> $GITHUB_OUTPUT
          else
            echo "Using freshly built base stats"
            echo "from_cache=false" >> $GITHUB_OUTPUT
            echo "base_build_success=${{ steps.base-build.outputs.base_build_success }}" >> $GITHUB_OUTPUT
            echo "base_total=${{ steps.base-build.outputs.base_total }}" >> $GITHUB_OUTPUT
            echo "base_js=${{ steps.base-build.outputs.base_js }}" >> $GITHUB_OUTPUT
            echo "base_css=${{ steps.base-build.outputs.base_css }}" >> $GITHUB_OUTPUT
            echo "base_html=${{ steps.base-build.outputs.base_html }}" >> $GITHUB_OUTPUT
            echo "base_img=${{ steps.base-build.outputs.base_img }}" >> $GITHUB_OUTPUT
            echo "base_total_size=${{ steps.base-build.outputs.base_total_size }}" >> $GITHUB_OUTPUT
            echo "base_js_size=${{ steps.base-build.outputs.base_js_size }}" >> $GITHUB_OUTPUT
            echo "base_css_size=${{ steps.base-build.outputs.base_css_size }}" >> $GITHUB_OUTPUT
            # Also forward error if present
            if [ -n "${{ steps.base-build.outputs.base_build_error }}" ]; then
              {
                echo "base_build_error<<ERROR_EOF"
                echo "${{ steps.base-build.outputs.base_build_error }}"
                echo "ERROR_EOF"
              } >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        run: npm ci

      - name: Type check
        id: typecheck
        run: |
          # Enable TypeScript problem matcher for inline annotations
          echo "::add-matcher::.github/matchers/typescript.json"

          echo "## TypeScript Check" >> $GITHUB_STEP_SUMMARY
          if npm run typecheck 2>&1 | tee typecheck-output.txt; then
            echo "‚úÖ No type errors found" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Type errors detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat typecheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
            # Output errors again for the matcher to pick up
            cat typecheck-output.txt
            exit 1
          fi

          echo "::remove-matcher owner=tsc::"

      - name: Update PR comment after typecheck
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const typecheckStatus = '${{ steps.typecheck.outputs.status }}';
            const typeIcon = typecheckStatus === 'success' ? '‚úÖ' : (typecheckStatus === 'failure' ? '‚ùå' : '‚è≥');
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const commitSha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- build-report -->')
              );

              if (botComment) {
                const body = `<!-- build-report -->
## CI Report<!-- preview-marker -->

${typeIcon} Types ¬∑ ‚è≥ Build ¬∑ ‚è≥ Stats

_Building..._

\`${commitSha}\` ¬∑ ${runUrl} ¬∑ _${timestamp}_`;

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              }
            } catch (error) {
              console.error('Failed to update PR comment:', error);
            }

      - name: Get PR head commit timestamp
        id: pr-commit
        run: |
          # Get the timestamp of the actual PR head commit (not the merge commit)
          COMMIT_TIMESTAMP=$(git log -1 --format=%cI ${{ github.event.pull_request.head.sha }})
          echo "timestamp=${COMMIT_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "PR head commit: ${{ github.event.pull_request.head.sha }}"
          echo "Commit timestamp: ${COMMIT_TIMESTAMP}"

      - name: Build PR branch
        id: build
        run: |
          echo "## Build" >> $GITHUB_STEP_SUMMARY
          BUILD_START=$(date +%s)
          npm run build
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "‚úÖ Build completed in ${BUILD_TIME}s" >> $GITHUB_STEP_SUMMARY
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        env:
          CI: true
          # Use PR head commit info, not the merge commit that GitHub creates for PR checks
          GATSBY_BUILD_TIME: ${{ steps.pr-commit.outputs.timestamp }}
          GATSBY_COMMIT_SHA: ${{ github.event.pull_request.head.sha }}

      - name: Generate build stats and compare
        id: stats
        env:
          BASE_BUILD_ERROR: ${{ steps.base-stats.outputs.base_build_error }}
        run: |
          set -euo pipefail

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify public directory exists
          if [ ! -d "public" ]; then
            echo "Error: public directory does not exist after build"
            exit 1
          fi

          # Calculate PR build sizes
          total_bytes=$(du -sb public | cut -f1)
          total_size=$(du -sh public | cut -f1)

          js_files=$(find public -name '*.js' -type f 2>/dev/null)
          if [ -n "$js_files" ]; then
            js_bytes=$(echo "$js_files" | xargs du -cb | tail -1 | cut -f1)
            js_size=$(echo "$js_files" | xargs du -ch | tail -1 | cut -f1)
          else
            js_bytes=0
            js_size="0"
          fi

          css_files=$(find public -name '*.css' -type f 2>/dev/null)
          if [ -n "$css_files" ]; then
            css_bytes=$(echo "$css_files" | xargs du -cb | tail -1 | cut -f1)
            css_size=$(echo "$css_files" | xargs du -ch | tail -1 | cut -f1)
          else
            css_bytes=0
            css_size="0"
          fi

          html_count=$(find public -name '*.html' -type f 2>/dev/null | wc -l | tr -d ' ')
          img_count=$(find public \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.gif' -o -name '*.svg' -o -name '*.webp' \) -type f 2>/dev/null | wc -l | tr -d ' ')

          # Get top 5 largest JS files
          TOP_JS=$(find public -name "*.js" -type f -exec du -h {} \; 2>/dev/null | sort -rh | head -5)

          # Store outputs for PR comment
          echo "total_size=${total_size}" >> $GITHUB_OUTPUT
          echo "total_bytes=${total_bytes}" >> $GITHUB_OUTPUT
          echo "html_count=${html_count}" >> $GITHUB_OUTPUT
          echo "js_size=${js_size}" >> $GITHUB_OUTPUT
          echo "js_bytes=${js_bytes}" >> $GITHUB_OUTPUT
          echo "css_size=${css_size}" >> $GITHUB_OUTPUT
          echo "css_bytes=${css_bytes}" >> $GITHUB_OUTPUT
          echo "img_count=${img_count}" >> $GITHUB_OUTPUT

          # Check if base build succeeded for comparison
          if [ "${{ steps.base-stats.outputs.base_build_success }}" = "true" ]; then
            # Use defaults to prevent arithmetic errors if outputs are empty
            base_total="${{ steps.base-stats.outputs.base_total }}"
            base_js="${{ steps.base-stats.outputs.base_js }}"
            base_css="${{ steps.base-stats.outputs.base_css }}"
            base_html="${{ steps.base-stats.outputs.base_html }}"
            base_img="${{ steps.base-stats.outputs.base_img }}"

            delta_total=$((total_bytes - ${base_total:-0}))
            delta_js=$((js_bytes - ${base_js:-0}))
            delta_css=$((css_bytes - ${base_css:-0}))
            delta_html=$((html_count - ${base_html:-0}))
            delta_img=$((img_count - ${base_img:-0}))

            echo "has_comparison=true" >> $GITHUB_OUTPUT
            echo "delta_total=${delta_total}" >> $GITHUB_OUTPUT
            echo "delta_js=${delta_js}" >> $GITHUB_OUTPUT
            echo "delta_css=${delta_css}" >> $GITHUB_OUTPUT
            echo "delta_html=${delta_html}" >> $GITHUB_OUTPUT
            echo "delta_img=${delta_img}" >> $GITHUB_OUTPUT

            # Get human-readable base sizes
            base_total_size="${{ steps.base-stats.outputs.base_total_size }}"
            base_js_size="${{ steps.base-stats.outputs.base_js_size }}"
            base_css_size="${{ steps.base-stats.outputs.base_css_size }}"

            # Write to step summary with comparison (Base | PR | Delta)
            echo "| Metric | Base | PR | Œî |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----:|---:|--:|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Size | ${base_total_size} | ${total_size} | ${delta_total} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| JavaScript | ${base_js_size} | ${js_size} | ${delta_js} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS | ${base_css_size} | ${css_size} | ${delta_css} bytes |" >> $GITHUB_STEP_SUMMARY
            echo "| HTML Pages | ${base_html} | ${html_count} | ${delta_html} |" >> $GITHUB_STEP_SUMMARY
            echo "| Images | ${base_img} | ${img_count} | ${delta_img} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_comparison=false" >> $GITHUB_OUTPUT

            # Write to step summary without comparison
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------:|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Size | ${total_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| HTML Pages | ${html_count} |" >> $GITHUB_STEP_SUMMARY
            echo "| JavaScript | ${js_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS | ${css_size} |" >> $GITHUB_STEP_SUMMARY
            echo "| Images | ${img_count} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ‚ö†Ô∏è _Base branch (\`${{ github.base_ref }}\`) build failed - comparison not available._" >> $GITHUB_STEP_SUMMARY

            # Show error if captured (passed via env for safe multiline handling)
            base_error=$(echo "$BASE_BUILD_ERROR" | sed '/^[[:space:]]*$/d')
            if [ -n "$base_error" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>Build error</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$base_error" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Save top JS files using heredoc
          {
            echo "top_js<<TOPJS_EOF"
            echo "$TOP_JS"
            echo "TOPJS_EOF"
          } >> $GITHUB_OUTPUT

      - name: Check for large bundles
        id: bundles
        run: |
          set -euo pipefail

          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find JS files larger than 200KB
          large_files=$(find public -name "*.js" -type f -size +200k 2>/dev/null || true)

          if [ -n "$large_files" ]; then
            large_count=$(echo "$large_files" | wc -l | tr -d ' ')
            echo "large_count=${large_count}" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è **Large JavaScript files (>200KB): ${large_count}**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$large_files" | xargs du -h | sort -rh >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "has_large=true" >> $GITHUB_OUTPUT
          else
            echo "large_count=0" >> $GITHUB_OUTPUT
            echo "‚úÖ No JavaScript files exceed 200KB" >> $GITHUB_STEP_SUMMARY
            echo "has_large=false" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment with build stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          # Pass multiline/complex values via env to avoid template literal issues
          TOP_JS: ${{ steps.stats.outputs.top_js }}
          BASE_BUILD_ERROR: ${{ steps.base-stats.outputs.base_build_error }}
        with:
          script: |
            // Helper to format bytes
            const formatBytes = (bytes) => {
              const abs = Math.abs(bytes);
              if (abs >= 1048576) return (bytes / 1048576).toFixed(2) + 'M';
              if (abs >= 1024) return (bytes / 1024).toFixed(1) + 'K';
              return bytes + 'B';
            };

            // Helper to format delta with icon
            const formatDelta = (delta) => {
              if (delta === 0) return '-';
              const sign = delta > 0 ? '+' : '';
              const icon = delta > 0 ? 'üìà' : 'üìâ';
              return `${sign}${formatBytes(delta)} ${icon}`;
            };

            // Get build stats (simple single-line values are safe to inline)
            const totalSize = '${{ steps.stats.outputs.total_size }}';
            const totalBytes = parseInt('${{ steps.stats.outputs.total_bytes }}') || 0;
            const htmlCount = parseInt('${{ steps.stats.outputs.html_count }}') || 0;
            const jsSize = '${{ steps.stats.outputs.js_size }}';
            const jsBytes = parseInt('${{ steps.stats.outputs.js_bytes }}') || 0;
            const cssSize = '${{ steps.stats.outputs.css_size }}';
            const cssBytes = parseInt('${{ steps.stats.outputs.css_bytes }}') || 0;
            const imgCount = parseInt('${{ steps.stats.outputs.img_count }}') || 0;
            const buildTime = '${{ steps.build.outputs.build_time }}';
            const hasLargeBundles = '${{ steps.bundles.outputs.has_large }}' === 'true';
            const largeCount = '${{ steps.bundles.outputs.large_count }}';
            const baseBranch = '${{ github.base_ref }}';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Check if comparison is available
            const hasComparison = '${{ steps.stats.outputs.has_comparison }}' === 'true';

            // Get base stats and deltas (only if comparison available)
            let baseTotalSize = '', baseJsSize = '', baseCssSize = '', baseHtml = 0, baseImg = 0;
            let deltaTotal = 0, deltaJs = 0, deltaCss = 0, deltaHtml = 0, deltaImg = 0;
            if (hasComparison) {
              baseTotalSize = '${{ steps.base-stats.outputs.base_total_size }}';
              baseJsSize = '${{ steps.base-stats.outputs.base_js_size }}';
              baseCssSize = '${{ steps.base-stats.outputs.base_css_size }}';
              baseHtml = parseInt('${{ steps.base-stats.outputs.base_html }}') || 0;
              baseImg = parseInt('${{ steps.base-stats.outputs.base_img }}') || 0;
              deltaTotal = parseInt('${{ steps.stats.outputs.delta_total }}') || 0;
              deltaJs = parseInt('${{ steps.stats.outputs.delta_js }}') || 0;
              deltaCss = parseInt('${{ steps.stats.outputs.delta_css }}') || 0;
              deltaHtml = parseInt('${{ steps.stats.outputs.delta_html }}') || 0;
              deltaImg = parseInt('${{ steps.stats.outputs.delta_img }}') || 0;
            }

            // Get typecheck and other status
            const typecheckStatus = '${{ steps.typecheck.outputs.status }}' === 'success';
            const commitSha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);

            // Format top JS files (from env to handle multiline safely)
            const topJs = (process.env.TOP_JS || '').trim();
            const topJsFormatted = topJs ? topJs.split('\n').map(line => {
              const parts = line.trim().split(/\s+/);
              if (parts.length >= 2) {
                const size = parts[0];
                const file = parts[1].replace('public/', '');
                return `| \`${file}\` | ${size} |`;
              }
              return '';
            }).filter(Boolean).join('\n') : '';

            // Build status line
            const typeIcon = typecheckStatus ? '‚úÖ' : '‚ùå';
            const bundleIcon = hasLargeBundles ? '‚ö†Ô∏è' : '‚úÖ';
            const deltaDisplay = hasComparison ? formatDelta(deltaTotal) : totalSize;
            const statusLine = `${typeIcon} Types ¬∑ ${bundleIcon} Bundles ¬∑ üìä ${deltaDisplay} ¬∑ ‚è±Ô∏è ${buildTime}s`;

            // Helper for formatting count deltas
            const formatCountDelta = (delta) => {
              if (delta === 0) return '-';
              return (delta > 0 ? '+' : '') + delta;
            };

            // Build the stats table (with or without comparison)
            let statsTable;
            if (hasComparison) {
              statsTable = `| Metric | Base | PR | Œî |
            |:-------|-----:|---:|--:|
            | üì¶ Total Size | ${baseTotalSize} | **${totalSize}** | ${formatDelta(deltaTotal)} |
            | üìú JavaScript | ${baseJsSize} | **${jsSize}** | ${formatDelta(deltaJs)} |
            | üé® CSS | ${baseCssSize} | **${cssSize}** | ${formatDelta(deltaCss)} |
            | üìÑ HTML Pages | ${baseHtml} | **${htmlCount}** | ${formatCountDelta(deltaHtml)} |
            | üñºÔ∏è Images | ${baseImg} | **${imgCount}** | ${formatCountDelta(deltaImg)} |`;
            } else {
              // Get error from env (safe for multiline content)
              const baseError = (process.env.BASE_BUILD_ERROR || '').trim();
              const errorNote = baseError
                ? `\n\n<details>\n<summary>Build error</summary>\n\n\`\`\`\n${baseError}\n\`\`\`\n</details>`
                : '';

              statsTable = `| Metric | Value |
            |:-------|------:|
            | üì¶ Total Size | **${totalSize}** |
            | üìú JavaScript | **${jsSize}** |
            | üé® CSS | **${cssSize}** |
            | üìÑ HTML Pages | **${htmlCount}** |
            | üñºÔ∏è Images | **${imgCount}** |

            > ‚ö†Ô∏è _Base branch (\`${baseBranch}\`) build failed - comparison not available._${errorNote}`;
            }

            // Build large bundles section (only if there are large bundles)
            let bundleSection = '';
            if (hasLargeBundles && topJsFormatted) {
              bundleSection = `
            **${largeCount} bundle(s) exceed 200KB:**

            | File | Size |
            |:-----|-----:|
            ${topJsFormatted}
            `;
            }

            // Check if preview deployment is configured
            const hasSurgeToken = '${{ secrets.SURGE_TOKEN }}' !== '';
            const previewPlaceholder = hasSurgeToken ? ' ¬∑ üöÄ _deploying..._<!-- preview-marker -->' : '<!-- preview-marker -->';

            // Build footer with base comparison info and timestamp
            const baseSha = '${{ steps.base-sha.outputs.short_sha }}';
            const fromCache = '${{ steps.base-stats.outputs.from_cache }}' === 'true';
            const cacheIndicator = fromCache ? ' üì¶' : '';
            const baseRef = hasComparison ? ` ¬∑ vs \`${baseBranch}@${baseSha}\`${cacheIndicator}` : '';
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const body = `<!-- build-report -->
            ## CI Report${previewPlaceholder}

            ${statusLine}

            ${statsTable}
            ${bundleSection}
            \`${commitSha}\`${baseRef} ¬∑ ${runUrl} ¬∑ _${timestamp}_`;

            // Find existing comment and post/update
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- build-report -->')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (error) {
              console.error('Failed to post PR comment:', error);
              // Don't fail the workflow if comment posting fails
            }

      - name: Deploy preview to Surge
        id: surge
        if: github.event_name == 'pull_request'
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          set -uo pipefail

          PREVIEW_URL="pr-${{ github.event.pull_request.number }}-andreicozma1.surge.sh"
          FULL_URL="https://${PREVIEW_URL}"
          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "url=${FULL_URL}" >> $GITHUB_OUTPUT

          if [ -z "${SURGE_TOKEN:-}" ]; then
            echo "::notice::SURGE_TOKEN not configured - skipping preview deployment"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "deployed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Deploy to Surge
          echo "Deploying to ${FULL_URL}..."
          if ! npx surge ./public "${PREVIEW_URL}" --token "$SURGE_TOKEN" 2>&1; then
            echo "::error::Surge deployment command failed"
            echo "status=deploy_failed" >> $GITHUB_OUTPUT
            echo "deployed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Verify deployment is accessible
          echo "Verifying deployment..."
          sleep 3
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${FULL_URL}" --max-time 15 || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Preview deployed and verified: ${FULL_URL}"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "deployed=true" >> $GITHUB_OUTPUT
          elif [ "$HTTP_STATUS" = "000" ]; then
            echo "::warning::Deployment completed but site unreachable (timeout)"
            echo "status=unverified" >> $GITHUB_OUTPUT
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Deployment completed but unexpected status: HTTP ${HTTP_STATUS}"
            echo "status=unverified" >> $GITHUB_OUTPUT
            echo "deployed=true" >> $GITHUB_OUTPUT
          fi

      - name: Update PR comment with preview URL
        if: github.event_name == 'pull_request' && steps.surge.outputs.deployed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.surge.outputs.url }}';
            const status = '${{ steps.surge.outputs.status }}';

            // Add status indicator if not fully verified
            const statusSuffix = status === 'success' ? '' : ' ‚ö†Ô∏è';

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- build-report -->')
              );

              if (botComment && !botComment.body.includes('<!-- preview-url -->')) {
                // Replace placeholder (with or without "deploying..." text)
                const updatedBody = botComment.body.replace(
                  / ¬∑ üöÄ _deploying\.\.\._<!-- preview-marker -->|<!-- preview-marker -->/,
                  ` ¬∑ üöÄ ${previewUrl}${statusSuffix}<!-- preview-url -->`
                );

                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: updatedBody
                });
                console.log(`Updated PR comment with preview URL (status: ${status})`);
              } else if (!botComment) {
                console.log('No build report comment found to update');
              } else {
                console.log('Preview URL already present in comment');
              }
            } catch (error) {
              console.error('Failed to update PR comment with preview URL:', error);
              core.warning(`Failed to update PR comment: ${error.message}`);
            }
